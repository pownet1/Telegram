{"version":3,"file":"pagePassword-d3657e8d.js","sources":["../src/components/passwordInputField.ts","../src/components/monkeys/password.ts","../src/helpers/dom/htmlToSpan.ts","../src/pages/pagePassword.ts"],"sourcesContent":["/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport cancelEvent from '../helpers/dom/cancelEvent';\nimport Icon from './icon';\nimport InputField, {InputFieldOptions} from './inputField';\n\nexport class PasswordInputHelpers {\n  public passwordVisible = false;\n  public toggleVisible: HTMLElement;\n  public onVisibilityClickAdditional: () => void;\n\n  constructor(public container: HTMLElement, public input: HTMLInputElement) {\n    input.type = 'password';\n    input.setAttribute('required', '');\n    input.name = 'notsearch_password';\n    input.autocomplete = 'off';\n\n    // * https://stackoverflow.com/a/35949954/6758968\n    const stealthy = document.createElement('input');\n    stealthy.classList.add('stealthy');\n    stealthy.tabIndex = -1;\n    stealthy.type = 'password';\n    input.parentElement.prepend(stealthy);\n    input.parentElement.insertBefore(stealthy.cloneNode(), input.nextSibling);\n\n    /* if(IS_SAFARI && !IS_MOBILE_SAFARI) {\n      input.setAttribute('readonly', '');\n      input.addEventListener('focus', () => {\n        input.removeAttribute('readonly');\n      }, {once: true});\n    } */\n\n    const toggleVisible = this.toggleVisible = document.createElement('span');\n    toggleVisible.classList.add('toggle-visible');\n    toggleVisible.append(Icon('eye1'));\n\n    container.classList.add('input-field-password');\n    container.append(toggleVisible);\n\n    toggleVisible.addEventListener('click', this.onVisibilityClick);\n    toggleVisible.addEventListener('touchend', this.onVisibilityClick);\n  }\n\n  public onVisibilityClick = (e: Event) => {\n    cancelEvent(e);\n    this.passwordVisible = !this.passwordVisible;\n\n    this.toggleVisible.replaceChildren(Icon(this.passwordVisible ? 'eye2' : 'eye1'));\n    (this.input as HTMLInputElement).type = this.passwordVisible ? 'text' : 'password';\n    this.onVisibilityClickAdditional?.();\n  };\n}\n\nexport default class PasswordInputField extends InputField {\n  public helpers: PasswordInputHelpers;\n\n  constructor(options: InputFieldOptions = {}) {\n    super({\n      plainText: true,\n      ...options\n    });\n\n    this.helpers = new PasswordInputHelpers(this.container, this.input as HTMLInputElement);\n  }\n}\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport lottieLoader, {LottieLoader} from '../../lib/rlottie/lottieLoader';\nimport RLottiePlayer from '../../lib/rlottie/rlottiePlayer';\nimport PasswordInputField from '../passwordInputField';\n\nexport default class PasswordMonkey {\n  public container: HTMLElement;\n  public animation: RLottiePlayer;\n  public needFrame = 0;\n  protected loadPromise: ReturnType<LottieLoader['waitForFirstFrame']>;\n\n  constructor(protected passwordInputField: PasswordInputField, protected size: number) {\n    this.container = document.createElement('div');\n    this.container.classList.add('media-sticker-wrapper');\n  }\n\n  public load() {\n    if(this.loadPromise) return this.loadPromise;\n    return this.loadPromise = lottieLoader.loadAnimationAsAsset({\n      container: this.container,\n      loop: false,\n      autoplay: false,\n      width: this.size,\n      height: this.size,\n      noCache: true\n    // }, 'assets/img/TwoFactorSetupMonkeyClose.tgs').then((_animation) => {\n    }, 'TwoFactorSetupMonkeyPeek').then((_animation) => {\n      // return;\n      this.animation = _animation;\n      this.animation.addEventListener('enterFrame', currentFrame => {\n        // console.log('enterFrame', currentFrame, this.needFrame);\n\n        if((this.animation.direction === 1 && currentFrame >= this.needFrame) ||\n          (this.animation.direction === -1 && currentFrame <= this.needFrame)) {\n          this.animation.setSpeed(1);\n          this.animation.pause();\n        }\n      });\n\n      this.passwordInputField.helpers.onVisibilityClickAdditional = () => {\n        if(this.passwordInputField.helpers.passwordVisible) {\n          this.animation.setDirection(1);\n          this.animation.curFrame = 0;\n          this.needFrame = 16;\n          this.animation.play();\n        } else {\n          this.animation.setDirection(-1);\n          this.animation.curFrame = 16;\n          this.needFrame = 0;\n          this.animation.play();\n        }\n      };\n\n      return lottieLoader.waitForFirstFrame(_animation);\n    });\n  }\n\n  public remove() {\n    if(this.animation) {\n      this.animation.remove();\n    }\n  }\n}\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport default function htmlToSpan(html: string | DocumentFragment) {\n  const span = document.createElement('span');\n  if(typeof(html) === 'string') span.innerHTML = html;\n  else span.append(html);\n  return span;\n}\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {putPreloader} from '../components/putPreloader';\r\nimport mediaSizes from '../helpers/mediaSizes';\r\nimport {AccountPassword} from '../layer';\r\nimport Page from './page';\r\nimport Button from '../components/button';\r\nimport PasswordInputField from '../components/passwordInputField';\r\nimport PasswordMonkey from '../components/monkeys/password';\r\nimport I18n from '../lib/langPack';\r\nimport LoginPage from './loginPage';\r\nimport cancelEvent from '../helpers/dom/cancelEvent';\r\nimport {attachClickEvent} from '../helpers/dom/clickEvent';\r\nimport htmlToSpan from '../helpers/dom/htmlToSpan';\r\nimport replaceContent from '../helpers/dom/replaceContent';\r\nimport toggleDisability from '../helpers/dom/toggleDisability';\r\nimport wrapEmojiText from '../lib/richTextProcessor/wrapEmojiText';\r\nimport rootScope from '../lib/rootScope';\r\n\r\nconst TEST = false;\r\nlet passwordInput: HTMLInputElement;\r\n\r\nconst onFirstMount = (): Promise<any> => {\r\n  const page = new LoginPage({\r\n    className: 'page-password',\r\n    withInputWrapper: true,\r\n    titleLangKey: 'Login.Password.Title',\r\n    subtitleLangKey: 'Login.Password.Subtitle'\r\n  });\r\n\r\n  const btnNext = Button('btn-primary btn-color-primary');\r\n  const btnNextI18n = new I18n.IntlElement({key: 'Login.Next'});\r\n\r\n  btnNext.append(btnNextI18n.element);\r\n\r\n  const passwordInputField = new PasswordInputField({\r\n    label: 'LoginPassword',\r\n    name: 'password'\r\n  });\r\n\r\n  passwordInput = passwordInputField.input as HTMLInputElement;\r\n\r\n  page.inputWrapper.append(passwordInputField.container, btnNext);\r\n\r\n  let getStateInterval: number;\r\n\r\n  const getState = () => {\r\n    // * just to check session relevance\r\n    if(!getStateInterval) {\r\n      getStateInterval = window.setInterval(getState, 10e3);\r\n    }\r\n\r\n    return !TEST && rootScope.managers.passwordManager.getState().then((_state) => {\r\n      state = _state;\r\n\r\n      if(state.hint) {\r\n        replaceContent(passwordInputField.label, htmlToSpan(wrapEmojiText(state.hint)));\r\n      } else {\r\n        passwordInputField.setLabel();\r\n      }\r\n    });\r\n  };\r\n\r\n  let state: AccountPassword;\r\n\r\n  const onSubmit = (e?: Event) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(!passwordInput.value.length) {\r\n      passwordInput.classList.add('error');\r\n      return;\r\n    }\r\n\r\n    const toggle = toggleDisability([passwordInput, btnNext], true);\r\n    const value = passwordInput.value;\r\n\r\n    btnNextI18n.update({key: 'PleaseWait'});\r\n    const preloader = putPreloader(btnNext);\r\n\r\n    passwordInputField.setValueSilently('' + Math.random()); // prevent saving suggestion\r\n    passwordInputField.setValueSilently(value); // prevent saving suggestion\r\n\r\n    rootScope.managers.passwordManager.check(value, state).then((response) => {\r\n      // console.log('passwordManager response:', response);\r\n\r\n      switch(response._) {\r\n        case 'auth.authorization':\r\n          clearInterval(getStateInterval);\r\n          if(monkey) monkey.remove();\r\n          break;\r\n        default:\r\n          btnNext.removeAttribute('disabled');\r\n          btnNextI18n.update({key: response._ as any});\r\n          preloader.remove();\r\n          break;\r\n      }\r\n    }).catch((err: any) => {\r\n      toggle();\r\n      passwordInputField.input.classList.add('error');\r\n\r\n      switch(err.type) {\r\n        default:\r\n          // btnNext.innerText = err.type;\r\n          btnNextI18n.update({key: 'PASSWORD_HASH_INVALID'});\r\n          passwordInput.select();\r\n          break;\r\n      }\r\n\r\n      preloader.remove();\r\n\r\n      getState();\r\n    });\r\n  };\r\n\r\n  attachClickEvent(btnNext, onSubmit);\r\n\r\n  passwordInput.addEventListener('keypress', function(this, e) {\r\n    this.classList.remove('error');\r\n    btnNextI18n.update({key: 'Login.Next'});\r\n\r\n    if(e.key === 'Enter') {\r\n      return onSubmit();\r\n    }\r\n  });\r\n\r\n  const size = mediaSizes.isMobile ? 100 : 166;\r\n  const monkey = new PasswordMonkey(passwordInputField, size);\r\n  page.imageDiv.append(monkey.container);\r\n  return Promise.all([\r\n    monkey.load(),\r\n    getState()\r\n  ]);\r\n};\r\n\r\nconst page = new Page('page-password', true, onFirstMount, null, () => {\r\n  // if(!isAppleMobile) {\r\n  passwordInput.focus();\r\n  // }\r\n\r\n  rootScope.managers.appStateManager.pushToState('authState', {_: 'authStatePassword'});\r\n});\r\n\r\nexport default page;\r\n"],"names":["PasswordInputHelpers","container","input","e","cancelEvent","Icon","stealthy","toggleVisible","PasswordInputField","InputField","options","PasswordMonkey","passwordInputField","size","lottieLoader","_animation","currentFrame","htmlToSpan","html","span","passwordInput","onFirstMount","page","LoginPage","btnNext","Button","btnNextI18n","I18n","getStateInterval","getState","rootScope","_state","state","replaceContent","wrapEmojiText","onSubmit","toggle","toggleDisability","value","preloader","putPreloader","response","monkey","err","attachClickEvent","mediaSizes","Page"],"mappings":"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"}